<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<Class name="WEB.JSON">
<Description>
Обработка запросов к/от базы</Description>
<Super>%Base,%RegisteredObject</Super>
<TimeCreated>63004,63548.548932</TimeCreated>

<Method name="DefaultTemplate">
<Description>
Шаблон административной страницы</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
  set st=$$$OK
   &html<<h1>DefaultTemplate() Empty page <b> block </b></h1>>  
   
  quit st
]]></Implementation>
</Method>

<UDLText name="T">
<Content><![CDATA[
// -------------VACANCY RESPONSE-----------------------

]]></Content>
</UDLText>

<Method name="NVR">
<Description>
Добавить отзыв</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>compid:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	
	   set st=$$$OK
   try{
	   $$$THROWONERROR(st,##class(%ZEN.Auxiliary.jsonProvider).%ConvertJSONToObject(%request.Content,,.obj,1))
       
       set vr=##class(Vacancy.VacancyResponse).%New()
       set vacancy=##class(Vacancy.Vacancy).%OpenId(compid)
       //#dim a as %StringTimeStamp

       set vr.Vacancy=vacancy
       //set obj=$ZCONVERT(obj,"I","UTF8")
       set vr.FirstName=$ZCONVERT(obj.FirstName,"I","UTF8")
       
       set vr.LastName=$ZCONVERT(obj.LastName,"I","UTF8")
       set vr.From.Country=$ZCONVERT(obj.Country,"I","UTF8")
       set vr.From.State=$ZCONVERT(obj.State,"I","UTF8")
       set vr.From.City=$ZCONVERT(obj.City,"I","UTF8")
       set vr.From.Street=$ZCONVERT(obj.Street,"I","UTF8")
       set vr.From.Building=obj.Building
       set vr.From.Apartament=obj.Apartament
       set vr.From.Email=obj.Email
       set vr.From.Telephone=obj.Telephone
       //set vr.ResponseDate=##class(%Library.TimeStamp).OdbcToLogical($h)
       set vr.ResponseDate=$piece($H, ",")
       set vr.ResponseText=$ZCONVERT(obj.ResponseText,"I","UTF8") 
       $$$THROWONERROR(st,vr.%Save())
 
   } catch ex{set st=ex.AsStatus()}
    quit st
]]></Implementation>
</Method>

<UDLText name="T">
<Content><![CDATA[
// ------------- END VACANCY RESPONSE-----------------------

]]></Content>
</UDLText>

<UDLText name="T">
<Content><![CDATA[
// -------------VACANCY BEGIN-----------------------

]]></Content>
</UDLText>

<Method name="CreateVacancy">
<Description>
Добавить вакансию</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
		   set st=$$$OK
   try{
	   $$$THROWONERROR(st,##class(%ZEN.Auxiliary.jsonProvider).%ConvertJSONToObject(%request.Content,,.obj,1))
       
       set vacancy=##class(Vacancy.Vacancy).%New()
       set vacancy.Name=$ZCONVERT(obj.VacancyName,"I","UTF8")
       set vacancy.Skills=$ZCONVERT(obj.Skills,"I","UTF8")
       set vacancy.VacancyType=$ZCONVERT(obj.VacancyType,"I","UTF8")
       set vacancy.EduLevel=$ZCONVERT(obj.EduLevel,"I","UTF8")
       set vacancy.Institution=$ZCONVERT(obj.Institution,"I","UTF8")
       set vacancy.StartSalary=$ZCONVERT(obj.StartSalary,"I","UTF8")
       set vacancy.EndSalary=$ZCONVERT(obj.EndSalary,"I","UTF8")
       set vacancy.RegDate=$piece($H, ",")
       set vacancy.CityVacancy=$ZCONVERT(obj.CityVacancy,"I","UTF8")
       set vacancy.MainInfo=$ZCONVERT(obj.MainInfo,"I","UTF8")
       set vacancy.AddInfo=$ZCONVERT(obj.AddInfo,"I","UTF8")
       set vacancy.Seats=$ZCONVERT(obj.Seats,"I","UTF8")
       set vacancy.Company=##class(Vacancy.Company).%OpenId(obj.comid)
       //set vacancy.Links.URL=obj.Links_URL
              
       $$$THROWONERROR(st,vacancy.%Save())
 
   } catch ex{set st=ex.AsStatus()}
    quit st
]]></Implementation>
</Method>

<UDLText name="T">
<Content><![CDATA[
// <MDG.CTP>

]]></Content>
</UDLText>

<Method name="DeleteVacancy">
<Description>
Удалить вакансию</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>compid:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
   set st=$$$OK
   try{$$$THROWONERROR(st,##class(Vacancy.Vacancy).%DeleteId(compid))} 
   catch ex{set st=ex.AsStatus()}
   quit st
]]></Implementation>
</Method>

<UDLText name="T">
<Content><![CDATA[
// </MDG.CTP>

]]></Content>
</UDLText>

<UDLText name="T">
<Content><![CDATA[
// Обновить вакансию

]]></Content>
</UDLText>

<Method name="UpdateVacancy">
<ClassMethod>1</ClassMethod>
<FormalSpec>compid:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	   set st=$$$OK
   try{
	   $$$THROWONERROR(st,##class(%ZEN.Auxiliary.jsonProvider).%ConvertJSONToObject(%request.Content,,.obj,1))
       
       set vacancy=##class(Vacancy.Vacancy).%OpenId(compid)
      
       set vacancy.Name=$ZCONVERT(obj.VacancyName,"I","UTF8")
       set vacancy.Skills=$ZCONVERT(obj.Skills,"I","UTF8")
       set vacancy.VacancyType=$ZCONVERT(obj.VacancyTypes,"I","UTF8")
       set vacancy.EduLevel=$ZCONVERT(obj.EduLevel,"I","UTF8")
       set vacancy.Institution=$ZCONVERT(obj.Institution,"I","UTF8")
       set vacancy.StartSalary=$ZCONVERT(obj.StartSalary,"I","UTF8")
       set vacancy.EndSalary=$ZCONVERT(obj.EndSalary,"I","UTF8")
       set vacancy.RegDate=$piece($H, ",")
       set vacancy.CityVacancy=$ZCONVERT(obj.CityVacancy,"I","UTF8")
       set vacancy.MainInfo=$ZCONVERT(obj.MainInfo,"I","UTF8")
       set vacancy.AddInfo=$ZCONVERT(obj.AddInfo,"I","UTF8")
       set vacancy.Seats=$ZCONVERT(obj.Seats,"I","UTF8")
       set vacancy.Company=##class(Vacancy.Company).%OpenId(obj.CompanyName)
       //set vacancy.Links.URL=obj.Links_URL

       $$$THROWONERROR(st,vacancy.%Save())
 
   } catch ex{set st=ex.AsStatus()}
    quit st
]]></Implementation>
</Method>

<Method name="GetVacanciesOld">
<Description>
список вакансий старый</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	do ##class(WEB.JSON).GetJSONData("select *from Vacancy.Vacancy")
	quit $$$OK
]]></Implementation>
</Method>

<Method name="GetVacancies">
<Description>
список вакансий</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set vacQuery = "SELECT C.Name AS CompanyName, V.CityVacancy, V.VacancyType, "_ 
					      "V.ID AS IDVac, V.Name AS VacancyName, V.RegDate, V.StartSalary, V.EndSalary "_ 
				   "FROM Vacancy.Vacancy AS V "_
				   "INNER JOIN Vacancy.Company AS C ON V.Company=C.ID "_
				   "ORDER BY V.Company"
	do ##class(WEB.JSON).GetJSONData(vacQuery)
	quit $$$OK
]]></Implementation>
</Method>

<Method name="GetVacancy">
<Description>
список вакансий</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>compid:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
  set vacQuery = "SELECT C.Name AS CompanyName, C.CompMainInfo, V.CityVacancy, V.Skills, V.Links_URL, "_ 
					     "V.ID AS IDVac, V.VacancyType, V.Name AS VacancyName, V.RegDate, V.StartSalary, V.EndSalary, "_ 
					     "V.MainInfo, V.Institution, V.AddInfo,V.EduLevel "_
				   "FROM Vacancy.Vacancy AS V "_
				   "INNER JOIN Vacancy.Company AS C ON V.Company=C.ID "_
				   "WHERE V.ID="_compid_
				   "ORDER BY V.Company"
  do ##class(WEB.JSON).GetJSONData(vacQuery)
  quit $$$OK
]]></Implementation>
</Method>

<Method name="GetVacancyAndCompany">
<Description>
список вакансий 
Select V.Name, C.Name FROM Vacancy.Vacancy AS V INNER JOIN Vacancy.Company AS C ON V.Company = C.ID</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>compid:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
  do ##class(WEB.JSON).GetJSONData("Select V.Name, C.Name FROM Vacancy.Vacancy AS V INNER JOIN Vacancy.Company AS C ON V.Company = C.ID")
  // WHERE V.ID ="_compid)
  quit $$$OK
]]></Implementation>
</Method>

<UDLText name="T">
<Content><![CDATA[
// -------------VACANCY END-------------------------

]]></Content>
</UDLText>

<UDLText name="T">
<Content><![CDATA[
// -------------SYSTEMUSER BEGIN--------------------

]]></Content>
</UDLText>

<Method name="GetUsers">
<Description>
тут будем получать список Пользователей</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
  do ##class(WEB.JSON).GetJSONData("select *from Vacancy.SystemUser")
  quit $$$OK
]]></Implementation>
</Method>

<Method name="AuthVerify">
<Description>
метод аутентификации</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>login,pwd</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
  set phash = $system.Encryption.MD5Hash(pwd)
  set str = "SELECT FirstName FROM Vacancy.SystemUser WHERE Login = '"_login_"' AND Password = '"_phash_"'"

  do ##class(WEB.JSON).GetJSONData(str)
  quit $$$OK
]]></Implementation>
</Method>

<UDLText name="T">
<Content><![CDATA[
// -------------SYSTEMUSER END----------------------

]]></Content>
</UDLText>

<UDLText name="T">
<Content><![CDATA[
// -------------COMPANY BEGIN-----------------------

]]></Content>
</UDLText>

<Method name="GetCompany">
<Description>
Получаем одну конкретную компанию по ID
по хорошему compid надо проверять, т.к. 
переменная приходит снаружи</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>compid:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 
  do ##class(WEB.JSON).GetJSONData("select *from Vacancy.Company where ID="_compid)
  quit $$$OK
]]></Implementation>
</Method>

<Method name="GetAllCompanies">
<Description>
Просмотреть все компании</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 
  do ##class(WEB.JSON).GetJSONData("select *from Vacancy.Company")
  quit $$$OK
]]></Implementation>
</Method>

<Method name="GetCompaniesVacancies">
<Description>
Получить компании с кол-вом вакансий</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set cvQuery = "SELECT C.Name AS CVName, COUNT(V.ID) AS VCOUNT "_
				  "FROM Vacancy.Company AS C "_
				  "INNER JOIN Vacancy.Vacancy AS V ON C.ID=V.Company "_
				  "GROUP BY C.ID ORDER BY VCOUNT DESC"
	do ##class(WEB.JSON).GetJSONData(cvQuery)
  	quit $$$OK
]]></Implementation>
</Method>

<Method name="UpdateCompany">
<Description>
Обновить компанию</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>compid:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
   set st=$$$OK
   try{
	   $$$THROWONERROR(st,##class(%ZEN.Auxiliary.jsonProvider).%ConvertJSONToObject(%request.Content,,.obj,1))
       set comp=##class(Data.Company).%OpenId(compid)
       throw:comp=$$$NULLOREF ##class(%Exception.StatusException).CreateFromStatus($$$ERROR(5001,"Нэ нашёль компанию :("))
       // здесь надо перечислить все поля... 
       // или запомнить ID объекта и сохранить его целиком
       // или тупо set comp=obj
       set comp.Name=obj.Name
       $$$THROWONERROR(st,comp.%Save())
 
   } catch ex{set st=ex.AsStatus()}
    quit st
]]></Implementation>
</Method>

<Method name="DeleteCompany">
<Description>
Удалить компанию из БД</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>compid:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
  do ##class(Vacancy.Company).%DeleteId(compid)
  quit $$$OK
]]></Implementation>
</Method>

<Method name="CreateCompany">
<Description>
Добавить компанию в БД</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
     do ##class(WEB.JSON).CreateObject("Vacancy.Company")
     quit $$$OK
]]></Implementation>
</Method>

<UDLText name="T">
<Content><![CDATA[
// -------------COMPANY END-------------------------

]]></Content>
</UDLText>

<UDLText name="T">
<Content><![CDATA[
/***********
***УНИВЕРСАЛЬНЫЕ МЕТОДЫ***
    ***НАЧАЛО***/
]]></Content>
</UDLText>

<Method name="UpdateObject">
<Description>
пока не придумал как сделать этот метод универсальным
тупо set comp=obj не катит - надо пробежаться по всем полям объектов</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>compid:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
   set st=$$$OK
   
   /*
   try{
	   $$$THROWONERROR(st,##class(%ZEN.Auxiliary.jsonProvider).%ConvertJSONToObject(%request.Content,,.obj,1))
	   // пытаемся сделать обратное преобразование - из формата json в объект
       set comp=##class(Data.Company).%OpenId(compid)
       throw:comp=$$$NULLOREF ##class(%Exception.StatusException).CreateFromStatus($$$ERROR(5001,"Нэ нашёль компанию :("))
       set comp.Name=obj.Name
       $$$THROWONERROR(st,comp.%Save())
 
   } catch ex{
	  &html<<h1>entering <b>CATCH</b> block</h1>>  
	  set st=ex.AsStatus()
    }*/
    quit st
]]></Implementation>
</Method>

<Method name="DeleteObject">
<Description><![CDATA[
Удалить из БД<br/>
<var>compid</var>ID строка удаляемого объекта<br/>
<var>bd</var>имя удаляемой базы например Data.Company<br/>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>compid,bd:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	// %CompiledClass %ClassDefinition
   set st=$$$OK
   // пока не знаю как передать сюда объект, потому все остальные делете будут без трай кэтч
 /*   try{$$$THROWONERROR(st,##class(Vacancy._bd_).%DeleteId(compid))} 
   catch ex{set st=ex.AsStatus()}
  */ quit st
]]></Implementation>
</Method>

<Method name="CreateObject">
<Description>
Добавить ОБЪЕКТ в БД</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>bd:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
   set st=$$$OK
   try{$$$THROWONERROR(st,##class(%ZEN.Auxiliary.jsonProvider).%ConvertJSONToObject(%request.Content,bd,.obj,1))
	   $$$THROWONERROR(st,obj.%Save())} 
   catch ex{set st=ex.AsStatus()}
   quit st
]]></Implementation>
</Method>

<Method name="GetJSONData">
<Description>
тут будем получать список Чего Попросят
SqlRequest - текстовый SQL запрос</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>SQLRequest:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
  set st=$$$OK
   try{do ##class(%ZEN.Auxiliary.jsonSQLProvider).%WriteJSONFromSQL(,SQLRequest)}
   catch ex{set st=ex.AsStatus()}
  quit st
]]></Implementation>
</Method>

<Method name="tmpUpdateCompany">
<Description>
Методы - шаблоны для функций работающих с базой
Думаю стоит написать методы с 2-мя параметрами
один из которых - таблица в которой происходят изменения</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>compid:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
   set st=$$$OK
   try{
   } catch ex{
	  &html<<h1>entering <b>CATCH</b> block</h1>>  
	  set st=ex.AsStatus()
    }
    quit st
]]></Implementation>
</Method>

<UDLText name="T">
<Content><![CDATA[
/***КОНЕЦ***
***УНИВЕРСАЛЬНЫЕ МЕТОДЫ***
    ************/
]]></Content>
</UDLText>

<Method name="UpdateImage">
<ClassMethod>1</ClassMethod>
<FormalSpec>compid:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	   set st=$$$OK
   try{
	   $$$THROWONERROR(st,##class(%ZEN.Auxiliary.jsonProvider).%ConvertJSONToObject(%request.Content,,.obj,1))
	   
       set vv=##class(Vacancy.Vacancy).%OpenId(compid)
	   //set StreamFile=##class(%Stream.FileBinary).%New()
	   //set StreamFile.Filename=$g(PicFilename)
	  //set StreamFile=
	  
	  
	 // set vv.Img=obj.Image
	   //s sc=vv.Img.CopyFromAndSave(StreamFile)
       // set a =%request.MimeData("FileStream",1).ContentType 
       $$$THROWONERROR(st,vv.%Save())
 
   } catch ex{set st=ex.AsStatus()}
   
    quit st
]]></Implementation>
</Method>
</Class>
</Export>
